<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8">
  <meta name="zipstream" value="notranslate">
  <title>Index of <%= HTML.escape request_path %></title>
  <link rel="icon" type="image/png" href='data:image/png;base64,<%= Base64.encode({{ read_file("#{__DIR__}/../assets/favicon.png") }}) %>'/>

  <style>
    html {
      position: relative;
      min-height: 100%;
    }

    body {
      margin-bottom: 60px;
    }

    footer {
      position: absolute;
      bottom: 0;
      right: 0;
      left: 0;
      width: 100%;
      height: 60px;
      line-height: 60px;
      background-color: #f5f5f5;
      color: #4F545A;
    }

    .text-center {
      text-align: center !important;
    }

    /* Copyright (c) The Chromium Authors. All rights reserved. */
    h1 {
      border-bottom: 1px solid #c0c0c0;
      margin-bottom: 10px;
      padding-bottom: 10px;
      white-space: nowrap;
    }

    table {
      border-collapse: collapse;
    }

    th {
      cursor: pointer;
    }

    th[data-order="-1"]::after {
      content: "\2191";
    }

    th[data-order="1"]::after {
      content: "\2193";
    }

    th[data-order]::after {
      font-size: 75%;
      width: .8em;
      margin-inline-end: -.8em;
      text-align: end;
      vertical-align: text-bottom;
    }

    td.detailsColumn {
      padding-inline-start: 2em;
      text-align: end;
      white-space: nowrap;
    }

    a.icon {
      padding-inline-start: 1.5em;
      text-decoration: none;
    }

    a.icon:hover {
      text-decoration: underline;
    }

    a.file {
      background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAABnRSTlMAAAAAAABupgeRAAABHUlEQVR42o2RMW7DIBiF3498iHRJD5JKHurL+CRVBp+i2T16tTynF2gO0KSb5ZrBBl4HHDBuK/WXACH4eO9/CAAAbdvijzLGNE1TVZXfZuHg6XCAQESAZXbOKaXO57eiKG6ft9PrKQIkCQqFoIiQFBGlFIB5nvM8t9aOX2Nd18oDzjnPgCDpn/BH4zh2XZdlWVmWiUK4IgCBoFMUz9eP6zRN75cLgEQhcmTQIbl72O0f9865qLAAsURAAgKBJKEtgLXWvyjLuFsThCSstb8rBCaAQhDYWgIZ7myM+TUBjDHrHlZcbMYYk34cN0YSLcgS+wL0fe9TXDMbY33fR2AYBvyQ8L0Gk8MwREBrTfKe4TpTzwhArXWi8HI84h/1DfwI5mhxJamFAAAAAElFTkSuQmCC ") left top no-repeat;
    }

    a.dir {
      background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAd5JREFUeNqMU79rFUEQ/vbuodFEEkzAImBpkUabFP4ldpaJhZXYm/RiZWsv/hkWFglBUyTIgyAIIfgIRjHv3r39MePM7N3LcbxAFvZ2b2bn22/mm3XMjF+HL3YW7q28YSIw8mBKoBihhhgCsoORot9d3/ywg3YowMXwNde/PzGnk2vn6PitrT+/PGeNaecg4+qNY3D43vy16A5wDDd4Aqg/ngmrjl/GoN0U5V1QquHQG3q+TPDVhVwyBffcmQGJmSVfyZk7R3SngI4JKfwDJ2+05zIg8gbiereTZRHhJ5KCMOwDFLjhoBTn2g0ghagfKeIYJDPFyibJVBtTREwq60SpYvh5++PpwatHsxSm9QRLSQpEVSd7/TYJUb49TX7gztpjjEffnoVw66+Ytovs14Yp7HaKmUXeX9rKUoMoLNW3srqI5fWn8JejrVkK0QcrkFLOgS39yoKUQe292WJ1guUHG8K2o8K00oO1BTvXoW4yasclUTgZYJY9aFNfAThX5CZRmczAV52oAPoupHhWRIUUAOoyUIlYVaAa/VbLbyiZUiyFbjQFNwiZQSGl4IDy9sO5Wrty0QLKhdZPxmgGcDo8ejn+c/6eiK9poz15Kw7Dr/vN/z6W7q++091/AQYA5mZ8GYJ9K0AAAAAASUVORK5CYII= ") left top no-repeat;
    }

    a.up {
      background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAmlJREFUeNpsU0toU0EUPfPysx/tTxuDH9SCWhUDooIbd7oRUUTMouqi2iIoCO6lceHWhegy4EJFinWjrlQUpVm0IIoFpVDEIthm0dpikpf3ZuZ6Z94nrXhhMjM3c8895977BBHB2PznK8WPtDgyWH5q77cPH8PpdXuhpQT4ifR9u5sfJb1bmw6VivahATDrxcRZ2njfoaMv+2j7mLDn93MPiNRMvGbL18L9IpF8h9/TN+EYkMffSiOXJ5+hkD+PdqcLpICWHOHc2CC+LEyA/K+cKQMnlQHJX8wqYG3MAJy88Wa4OLDvEqAEOpJd0LxHIMdHBziowSwVlF8D6QaicK01krw/JynwcKoEwZczewroTvZirlKJs5CqQ5CG8pb57FnJUA0LYCXMX5fibd+p8LWDDemcPZbzQyjvH+Ki1TlIciElA7ghwLKV4kRZstt2sANWRjYTAGzuP2hXZFpJ/GsxgGJ0ox1aoFWsDXyyxqCs26+ydmagFN/rRjymJ1898bzGzmQE0HCZpmk5A0RFIv8Pn0WYPsiu6t/Rsj6PauVTwffTSzGAGZhUG2F06hEc9ibS7OPMNp6ErYFlKavo7MkhmTqCxZ/jwzGA9Hx82H2BZSw1NTN9Gx8ycHkajU/7M+jInsDC7DiaEmo1bNl1AMr9ASFgqVu9MCTIzoGUimXVAnnaN0PdBBDCCYbEtMk6wkpQwIG0sn0PQIUF4GsTwLSIFKNqF6DVrQq+IWVrQDxAYQC/1SsYOI4pOxKZrfifiUSbDUisif7XlpGIPufXd/uvdvZm760M0no1FZcnrzUdjw7au3vu/BVgAFLXeuTxhTXVAAAAAElFTkSuQmCC ") left top no-repeat;
    }

    #parentDirLinkBox {
      margin-bottom: 10px;
      padding-bottom: 10px;
    }
  </style>

</head>

<body>
  <h1>Index of <%= HTML.escape request_path %></h1>
  <% encoded_request_path = URI.encode_path(request_path) %>

  <% unless request_path == "/" %>
    <% parent_path = encoded_request_path.ends_with?("/") ? encoded_request_path : "#{encoded_request_path}/" %>

    <div id="parentDirLinkBox" style="display: block;">
      <a id="parentDirLink" class="icon up" href="<%= parent_path %>..">
        <span id="parentDirText">[parent directory]</span>
      </a>
    </div>
  <% end %>

  <table>
    <thead>
      <tr class="header" id="theader">
        <th id="nameColumnHeader" tabindex="0" role="button">Name</th>
        <th id="sizeColumnHeader" tabindex="0" role="button">Size</th>
        <th id="dateColumnHeader" tabindex="0" role="button">Date Modified</th>
      </tr>
    </thead>
    <tbody id="tbody">
    </tbody>
  </table>

  <script>
    // Copyright (c) The Chromium Authors. All rights reserved.
    function addRow(name, url, isdir, size, size_string, date_modified, date_modified_string) {
      var root = document.location.pathname;
      if (root.substr(-1) !== "/")
        root += "/";

      var tbody = document.getElementById("tbody");
      var row = document.createElement("tr");
      var file_cell = document.createElement("td");
      var link = document.createElement("a");

      link.className = isdir ? "icon dir" : "icon file";

      if (isdir) {
        name = name + "/";
        url = url + "/";
        size = 0;
        size_string = "";
      } else {
        link.draggable = "true";
        link.addEventListener("dragstart", onDragStart, false);
      }
      link.innerText = name;
      link.href = root + url;
      link.href = url;

      file_cell.dataset.value = name;
      file_cell.appendChild(link);

      row.appendChild(file_cell);
      row.appendChild(createCell(size, size_string));
      row.appendChild(createCell(date_modified, date_modified_string));

      tbody.appendChild(row);
    }

    function onDragStart(e) {
      var el = e.srcElement;
      var name = el.innerText.replace(":", "");
      var download_url_data = "application/octet-stream:" + name + ":" + el.href;
      e.dataTransfer.setData("DownloadURL", download_url_data);
      e.dataTransfer.effectAllowed = "copy";
    }

    function createCell(value, text) {
      var cell = document.createElement("td");
      cell.setAttribute("class", "detailsColumn");
      cell.dataset.value = value;
      cell.innerText = text;
      return cell;
    }

    function sortTable(column) {
      var theader = document.getElementById("theader");
      var oldOrder = theader.cells[column].dataset.order || '1';
      oldOrder = parseInt(oldOrder, 10)
      var newOrder = 0 - oldOrder;
      for (let cell of theader.cells) {
        cell.removeAttribute('data-order');
      }
      theader.cells[column].dataset.order = newOrder;

      var tbody = document.getElementById("tbody");
      var rows = tbody.rows;
      var list = [], i;
      for (i = 0; i < rows.length; i++) {
        list.push(rows[i]);
      }

      list.sort(function (row1, row2) {
        var a = row1.cells[column].dataset.value;
        var b = row2.cells[column].dataset.value;
        if (column) {
          a = parseInt(a, 10);
          b = parseInt(b, 10);
          return a > b ? newOrder : a < b ? oldOrder : 0;
        }

        // Column 0 is text.
        switch (a.localeCompare(b, { sensitivity: 'base' })) {
          case 1:
            return newOrder;
          case -1:
            return oldOrder;
          default:
            return 0;
        }
      });

      // Appending an existing child again just moves it.
      for (i = 0; i < list.length; i++) {
        tbody.appendChild(list[i]);
      }
    }

    // Add event handlers to column headers.
    function addHandlers(element, column) {
      element.onclick = (e) => sortTable(column);
      element.onkeydown = (e) => {
        if (e.key == 'Enter' || e.key == ' ') {
          sortTable(column);
          e.preventDefault();
        }
      };
    }

    function onLoad() {
      addHandlers(document.getElementById('nameColumnHeader'), 0);
      addHandlers(document.getElementById('sizeColumnHeader'), 1);
      addHandlers(document.getElementById('dateColumnHeader'), 2);
    }

    window.addEventListener('DOMContentLoaded', onLoad);
  </script>

  <% each_file do |file| %>
    <% entry = File.basename(file.path) %>
    <script>
      addRow(
        "<%= HTML.escape(entry) %>",
        "<%= URI.encode_path(entry) %>",
        <%= file.info.directory? %>,
        <%= file.info.size %>,
        "<%= file.info.size.humanize_bytes %>",
        <%= file.info.modification_time.to_unix %>,
        "<%= file.info.modification_time %>"
      )
    </script>
  <% end %>
  <footer>
    <div class="text-center">
      Powered by <a href="https://github.com/mamantoha/zipstream">zipstream</a>/<%= Zipstream::VERSION %>

      (Crystal/<%= Crystal::VERSION %> crystar/<%= Crystar::VERSION %> crystal-zip64/<%= Zip64::VERSION %>)
    <div>
  </footer>
</body>

</html>
